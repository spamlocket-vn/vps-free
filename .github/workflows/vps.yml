name: 15 VPS Free Consolidated

on:
  workflow_dispatch:

jobs:
  vps:
    runs-on: ubuntu-latest
    steps:
      - name: Update & Install tmate
        run: |
          sudo apt update
          sudo apt install -y tmate curl wget gnupg

      - name: Cài Node.js + npm
        run: |
          curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node -v
          npm -v

      - name: Cài Google Chrome
        run: |
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb
          google-chrome --version

      - name: Cài thư viện Node (global)
        run: |
          npm install -g \
            yarn \
            pm2 \
            puppeteer \
            puppeteer-extra \
            puppeteer-extra-plugin-stealth \
            puppeteer-real-browser \
            axios \
            express
          echo "puppeteer-real-browser version:"
          npm list -g puppeteer-real-browser

      - name: Tải raw.js từ repo
        run: |
          wget -O raw.js "https://raw.githubusercontent.com/spamlocket-vn/vps-free/main/raw.js"
          ls -lh raw.js
          echo "📂 File raw.js đã được tải về, bạn SSH vào rồi chạy: node raw.js"

      - name: Start 15 tmate sessions
        run: |
          mkdir -p /tmp/tmate
          for i in {1..15}; do
            tmate -S /tmp/tmate/tmate-$i.sock new-session -d
            tmate -S /tmp/tmate/tmate-$i.sock wait tmate-ready
            echo "🔑 VPS$i SSH: $(tmate -S /tmp/tmate/tmate-$i.sock display -p '#{tmate_ssh}')"
            echo "🌐 VPS$i Web: $(tmate -S /tmp/tmate/tmate-$i.sock display -p '#{tmate_web}')"
          done > /tmp/tmate-links.txt
          echo "✅ All 15 VPS sessions are ready. SSH and Web links:"
          cat /tmp/tmate-links.txt

      - name: Keep alive 2h
        run: |
          echo "✅ All 15 VPS sessions are ready (raw.js available)."
          sleep 2h
